{% if gitlab_ssl_key is defined or gitlab_ssl_enabled == True %}
# SSL configuration
external_url "https://{{ ansible_fqdn }}{% if gitlab_ssl_port != 443 %}:{{ gitlab_ssl_port }}{% endif %}"
nginx['redirect_http_to_https'] = {{ gitlab_redirect_http | lower }}
nginx['ssl_certificate'] = "{{ gitlab_ssl_cert_path }}/{{ gitlab_ssl_filename }}.crt"
nginx['ssl_certificate_key'] = "{{ gitlab_ssl_key_path }}/{{ gitlab_ssl_filename }}.key"
{% else %}
external_url "http://{{ ansible_fqdn }}"
nginx['redirect_http_to_https'] = false
{% endif %}

{%- include 'gitlab.yml.j2' %}
{% include 'gitlab_application.j2' %}
{% include 'gitlab_database.j2' %}
{% include 'gitlab_redis.j2' %}
{% include 'gitlab_email.j2' %}

# User and group that owns GitLab data
# User for SSH access to GitLab server
user['username'] = '{{ gitlab_user_username }}'
user['group'] = '{{ gitlab_user_group }}'

{%- if gitlab_ci_enabled %}
{% if gitlab_ssl_key is defined or gitlab_ssl_enabled == True %}
# GitLab CI SSL configuration
ci_external_url "https://{{ gitlab_ci_fqdn }}{% if gitlab_ssl_port != 443 %}:{{ gitlab_ssl_port }}{% endif %}"
ci_nginx['redirect_http_to_https'] = {{ gitlab_redirect_http | lower }}
ci_nginx['ssl_certificate'] = "{{ gitlab_ssl_cert_path }}/{{ gitlab_ci_ssl_filename }}.crt"
ci_nginx['ssl_certificate_key'] = "{{ gitlab_ssl_key_path }}/{{ gitlab_ci_ssl_filename }}.key"
{% else %}
# GitLab CI Configuration
ci_external_url "http://{{ gitlab_ci_fqdn }}"
{% endif %}
{% endif %}
